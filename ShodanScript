from shodan import Shodan
from shodan.cli.helpers import get_api_key
import csv

api = Shodan(get_api_key())

fields = ['IP', 'CVE', 'CVSS', "CVE'ER", 'High CVES', 'Critical CVES']
print('Welcome to VULN scanner')

userInput = input('Enter organisation to scan for vulns: ')

uniqueIPs = []
uniqueMachines = []
limits = 5


results = api.search(f'org:{userInput} has_vuln:true', limit=limits)
print('Total results founds {}'.format(results['total']))

with open('data.csv', 'w', encoding='UTF8', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(fields)

    for result in results['matches']:
        numberOfCVEs = 0
        numberOfCriticalCVE = 0
        numberOfHighCVE = 0
        nameCVE = []
        print('Machine IP: {}'.format(result['ip_str']))  # Denne række skal væk
        for item in result['vulns']:
            numberOfCVEs = numberOfCVEs + 1
            cvssScore = float(result['vulns'][item]['cvss'])
            nameCVE.append(item)

            if cvssScore >= 9:
                numberOfCriticalCVE = numberOfCriticalCVE + 1
            elif 9 > cvssScore >= 7: #fucker dette det op?
                numberOfHighCVE = numberOfHighCVE + 1

            print("Number of high CVE: {}".format(numberOfHighCVE))
            print("Number of Critical cve: {}".format(numberOfCriticalCVE))
            print("CVSS: {}".format(cvssScore))
            print("Number of CVEs {}".format(numberOfCVEs))
        print("this is the length of nameCVE: {}".format(len(nameCVE)))
        rows = [result['ip_str'], nameCVE, cvssScore, numberOfCVEs, numberOfHighCVE, numberOfCriticalCVE]
        writer.writerow(rows)



